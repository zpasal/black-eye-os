#include <interrupts.h>
#include <string.h>
#include <gdt.h>

uint64_t __interrupt_handler_addresses[] = {
  (uint64_t) interrupt_handler_0,
  (uint64_t) interrupt_handler_1,
  (uint64_t) interrupt_handler_2,
  (uint64_t) interrupt_handler_3,
  (uint64_t) interrupt_handler_4,
  (uint64_t) interrupt_handler_5,
  (uint64_t) interrupt_handler_6,
  (uint64_t) interrupt_handler_7,
  (uint64_t) interrupt_handler_8,
  (uint64_t) interrupt_handler_9,
  (uint64_t) interrupt_handler_10,
  (uint64_t) interrupt_handler_11,
  (uint64_t) interrupt_handler_12,
  (uint64_t) interrupt_handler_13,
  (uint64_t) interrupt_handler_14,
  (uint64_t) interrupt_handler_15,
  (uint64_t) interrupt_handler_16,
  (uint64_t) interrupt_handler_17,
  (uint64_t) interrupt_handler_18,
  (uint64_t) interrupt_handler_19,
  (uint64_t) interrupt_handler_20,
  (uint64_t) interrupt_handler_21,
  (uint64_t) interrupt_handler_22,
  (uint64_t) interrupt_handler_23,
  (uint64_t) interrupt_handler_24,
  (uint64_t) interrupt_handler_25,
  (uint64_t) interrupt_handler_26,
  (uint64_t) interrupt_handler_27,
  (uint64_t) interrupt_handler_28,
  (uint64_t) interrupt_handler_29,
  (uint64_t) interrupt_handler_30,
  (uint64_t) interrupt_handler_31,
  (uint64_t) interrupt_handler_32,
  (uint64_t) interrupt_handler_33,
  (uint64_t) interrupt_handler_34,
  (uint64_t) interrupt_handler_35,
  (uint64_t) interrupt_handler_36,
  (uint64_t) interrupt_handler_37,
  (uint64_t) interrupt_handler_38,
  (uint64_t) interrupt_handler_39,
  (uint64_t) interrupt_handler_40,
  (uint64_t) interrupt_handler_41,
  (uint64_t) interrupt_handler_42,
  (uint64_t) interrupt_handler_43,
  (uint64_t) interrupt_handler_44,
  (uint64_t) interrupt_handler_45,
  (uint64_t) interrupt_handler_46,
  (uint64_t) interrupt_handler_47,
  (uint64_t) interrupt_handler_48,
  (uint64_t) interrupt_handler_49,
  (uint64_t) interrupt_handler_50,
  (uint64_t) interrupt_handler_51,
  (uint64_t) interrupt_handler_52,
  (uint64_t) interrupt_handler_53,
  (uint64_t) interrupt_handler_54,
  (uint64_t) interrupt_handler_55,
  (uint64_t) interrupt_handler_56,
  (uint64_t) interrupt_handler_57,
  (uint64_t) interrupt_handler_58,
  (uint64_t) interrupt_handler_59,
  (uint64_t) interrupt_handler_60,
  (uint64_t) interrupt_handler_61,
  (uint64_t) interrupt_handler_62,
  (uint64_t) interrupt_handler_63,
  (uint64_t) interrupt_handler_64,
  (uint64_t) interrupt_handler_65,
  (uint64_t) interrupt_handler_66,
  (uint64_t) interrupt_handler_67,
  (uint64_t) interrupt_handler_68,
  (uint64_t) interrupt_handler_69,
  (uint64_t) interrupt_handler_70,
  (uint64_t) interrupt_handler_71,
  (uint64_t) interrupt_handler_72,
  (uint64_t) interrupt_handler_73,
  (uint64_t) interrupt_handler_74,
  (uint64_t) interrupt_handler_75,
  (uint64_t) interrupt_handler_76,
  (uint64_t) interrupt_handler_77,
  (uint64_t) interrupt_handler_78,
  (uint64_t) interrupt_handler_79,
  (uint64_t) interrupt_handler_80,
  (uint64_t) interrupt_handler_81,
  (uint64_t) interrupt_handler_82,
  (uint64_t) interrupt_handler_83,
  (uint64_t) interrupt_handler_84,
  (uint64_t) interrupt_handler_85,
  (uint64_t) interrupt_handler_86,
  (uint64_t) interrupt_handler_87,
  (uint64_t) interrupt_handler_88,
  (uint64_t) interrupt_handler_89,
  (uint64_t) interrupt_handler_90,
  (uint64_t) interrupt_handler_91,
  (uint64_t) interrupt_handler_92,
  (uint64_t) interrupt_handler_93,
  (uint64_t) interrupt_handler_94,
  (uint64_t) interrupt_handler_95,
  (uint64_t) interrupt_handler_96,
  (uint64_t) interrupt_handler_97,
  (uint64_t) interrupt_handler_98,
  (uint64_t) interrupt_handler_99,
  (uint64_t) interrupt_handler_100,
  (uint64_t) interrupt_handler_101,
  (uint64_t) interrupt_handler_102,
  (uint64_t) interrupt_handler_103,
  (uint64_t) interrupt_handler_104,
  (uint64_t) interrupt_handler_105,
  (uint64_t) interrupt_handler_106,
  (uint64_t) interrupt_handler_107,
  (uint64_t) interrupt_handler_108,
  (uint64_t) interrupt_handler_109,
  (uint64_t) interrupt_handler_110,
  (uint64_t) interrupt_handler_111,
  (uint64_t) interrupt_handler_112,
  (uint64_t) interrupt_handler_113,
  (uint64_t) interrupt_handler_114,
  (uint64_t) interrupt_handler_115,
  (uint64_t) interrupt_handler_116,
  (uint64_t) interrupt_handler_117,
  (uint64_t) interrupt_handler_118,
  (uint64_t) interrupt_handler_119,
  (uint64_t) interrupt_handler_120,
  (uint64_t) interrupt_handler_121,
  (uint64_t) interrupt_handler_122,
  (uint64_t) interrupt_handler_123,
  (uint64_t) interrupt_handler_124,
  (uint64_t) interrupt_handler_125,
  (uint64_t) interrupt_handler_126,
  (uint64_t) interrupt_handler_127,
  (uint64_t) interrupt_handler_128,
  (uint64_t) interrupt_handler_129,
  (uint64_t) interrupt_handler_130,
  (uint64_t) interrupt_handler_131,
  (uint64_t) interrupt_handler_132,
  (uint64_t) interrupt_handler_133,
  (uint64_t) interrupt_handler_134,
  (uint64_t) interrupt_handler_135,
  (uint64_t) interrupt_handler_136,
  (uint64_t) interrupt_handler_137,
  (uint64_t) interrupt_handler_138,
  (uint64_t) interrupt_handler_139,
  (uint64_t) interrupt_handler_140,
  (uint64_t) interrupt_handler_141,
  (uint64_t) interrupt_handler_142,
  (uint64_t) interrupt_handler_143,
  (uint64_t) interrupt_handler_144,
  (uint64_t) interrupt_handler_145,
  (uint64_t) interrupt_handler_146,
  (uint64_t) interrupt_handler_147,
  (uint64_t) interrupt_handler_148,
  (uint64_t) interrupt_handler_149,
  (uint64_t) interrupt_handler_150,
  (uint64_t) interrupt_handler_151,
  (uint64_t) interrupt_handler_152,
  (uint64_t) interrupt_handler_153,
  (uint64_t) interrupt_handler_154,
  (uint64_t) interrupt_handler_155,
  (uint64_t) interrupt_handler_156,
  (uint64_t) interrupt_handler_157,
  (uint64_t) interrupt_handler_158,
  (uint64_t) interrupt_handler_159,
  (uint64_t) interrupt_handler_160,
  (uint64_t) interrupt_handler_161,
  (uint64_t) interrupt_handler_162,
  (uint64_t) interrupt_handler_163,
  (uint64_t) interrupt_handler_164,
  (uint64_t) interrupt_handler_165,
  (uint64_t) interrupt_handler_166,
  (uint64_t) interrupt_handler_167,
  (uint64_t) interrupt_handler_168,
  (uint64_t) interrupt_handler_169,
  (uint64_t) interrupt_handler_170,
  (uint64_t) interrupt_handler_171,
  (uint64_t) interrupt_handler_172,
  (uint64_t) interrupt_handler_173,
  (uint64_t) interrupt_handler_174,
  (uint64_t) interrupt_handler_175,
  (uint64_t) interrupt_handler_176,
  (uint64_t) interrupt_handler_177,
  (uint64_t) interrupt_handler_178,
  (uint64_t) interrupt_handler_179,
  (uint64_t) interrupt_handler_180,
  (uint64_t) interrupt_handler_181,
  (uint64_t) interrupt_handler_182,
  (uint64_t) interrupt_handler_183,
  (uint64_t) interrupt_handler_184,
  (uint64_t) interrupt_handler_185,
  (uint64_t) interrupt_handler_186,
  (uint64_t) interrupt_handler_187,
  (uint64_t) interrupt_handler_188,
  (uint64_t) interrupt_handler_189,
  (uint64_t) interrupt_handler_190,
  (uint64_t) interrupt_handler_191,
  (uint64_t) interrupt_handler_192,
  (uint64_t) interrupt_handler_193,
  (uint64_t) interrupt_handler_194,
  (uint64_t) interrupt_handler_195,
  (uint64_t) interrupt_handler_196,
  (uint64_t) interrupt_handler_197,
  (uint64_t) interrupt_handler_198,
  (uint64_t) interrupt_handler_199,
  (uint64_t) interrupt_handler_200,
  (uint64_t) interrupt_handler_201,
  (uint64_t) interrupt_handler_202,
  (uint64_t) interrupt_handler_203,
  (uint64_t) interrupt_handler_204,
  (uint64_t) interrupt_handler_205,
  (uint64_t) interrupt_handler_206,
  (uint64_t) interrupt_handler_207,
  (uint64_t) interrupt_handler_208,
  (uint64_t) interrupt_handler_209,
  (uint64_t) interrupt_handler_210,
  (uint64_t) interrupt_handler_211,
  (uint64_t) interrupt_handler_212,
  (uint64_t) interrupt_handler_213,
  (uint64_t) interrupt_handler_214,
  (uint64_t) interrupt_handler_215,
  (uint64_t) interrupt_handler_216,
  (uint64_t) interrupt_handler_217,
  (uint64_t) interrupt_handler_218,
  (uint64_t) interrupt_handler_219,
  (uint64_t) interrupt_handler_220,
  (uint64_t) interrupt_handler_221,
  (uint64_t) interrupt_handler_222,
  (uint64_t) interrupt_handler_223,
  (uint64_t) interrupt_handler_224,
  (uint64_t) interrupt_handler_225,
  (uint64_t) interrupt_handler_226,
  (uint64_t) interrupt_handler_227,
  (uint64_t) interrupt_handler_228,
  (uint64_t) interrupt_handler_229,
  (uint64_t) interrupt_handler_230,
  (uint64_t) interrupt_handler_231,
  (uint64_t) interrupt_handler_232,
  (uint64_t) interrupt_handler_233,
  (uint64_t) interrupt_handler_234,
  (uint64_t) interrupt_handler_235,
  (uint64_t) interrupt_handler_236,
  (uint64_t) interrupt_handler_237,
  (uint64_t) interrupt_handler_238,
  (uint64_t) interrupt_handler_239,
  (uint64_t) interrupt_handler_240,
  (uint64_t) interrupt_handler_241,
  (uint64_t) interrupt_handler_242,
  (uint64_t) interrupt_handler_243,
  (uint64_t) interrupt_handler_244,
  (uint64_t) interrupt_handler_245,
  (uint64_t) interrupt_handler_246,
  (uint64_t) interrupt_handler_247,
  (uint64_t) interrupt_handler_248,
  (uint64_t) interrupt_handler_249,
  (uint64_t) interrupt_handler_250,
  (uint64_t) interrupt_handler_251,
  (uint64_t) interrupt_handler_252,
  (uint64_t) interrupt_handler_253,
  (uint64_t) interrupt_handler_254,
  (uint64_t) interrupt_handler_255,
};

idtr_t __idtr;
idt_t  __interrupt_descriptor_table[IDT_INTERRUPT_TABLE_SIZE];

void init_idt() {
  // Prepare Interrupt Descriptor Table
  for (int i=0; i<IDT_INTERRUPT_TABLE_SIZE; i++) {
    idt_t*    idt = &__interrupt_descriptor_table[i];
    uint64_t addr = __interrupt_handler_addresses[i];

    idt->offset_0_15  = addr & 0x0000FFFF;
    idt->offset_16_31 = (addr >> 16) ;
    idt->offset_32_63 = addr >> 32;
    idt->ist          = 0;
    idt->zero         = 0;
    idt->selector     = KERNAL_GDT_SEGMENT_INDEX;
    idt->type_attr    = IDT_INTERRUPT_GATE;  
  }

  // Initialize IDTR and load it
  __idtr.limit = sizeof(idt_t) * 256 - 1;
  __idtr.base = __interrupt_descriptor_table;
  __asm__ volatile("lidt %0" :: "m"(__idtr));
}

